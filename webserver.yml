---

- hosts: webserver
  become: true
  tasks:
    # - name: install httpd
    #   yum:
    #     name: 
    #     state: present
    #     update_cache: yes
    #   # notify: restart httpd

    - name: install apache
      yum:
        name: [ "httpd", "mod_wsgi", "python34", "python-pip" ]
        state: present
        update_cache: yes
      notify: restart httpd

    - name: install virtualenv
      pip:
        name: virtualenv
        state: present

    - name: open firewall ports
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 80
        jump: ACCEPT
        comment: Apache HTTPD HTTP 80
        state: present
      notify: save iptables
  

    - name: open firewall ports
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 443
        jump: ACCEPT
        comment: Apache HTTPD HTTPS 443
        state: present
      notify: save iptables

    - name: ensure httpd is running
      service:
        name: httpd
        state: started
        enabled: yes


    - name: copy demo app source
      copy:
        src: demo/app/ # copy app/ folder with all contents
        dest: /var/www/demo
        mode: 0755
      notify: restart httpd


    - name: copy apache virtual host config
      copy:
        src: demo/demo.conf
        dest: /etc/httpd/sites-available # will create if not exists
        mode: 0755
      notify: restart httpd


    - name: setup python virtual environment
      pip:
        requirements: /var/www/demo/requirements.txt
        virtualenv: /var/www/demo/.venv
      notify: restart httpd

  handlers:
    - name: restart httpd
      service:
        name: httpd
        state: restarted

    - name: save iptables
      command: service iptables save
      become: yes
      notify: reload iptables

    - name: reload iptables
      service:
        name: iptables
        state: restarted
